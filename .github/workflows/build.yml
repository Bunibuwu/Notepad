name: CI - Build Notepad App (Nuitka)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # Common build step for all platforms
    - name: Build with Nuitka
      run: |
        mkdir -p build
        echo "Starting ${{ runner.os }} build..."
        
        # Basic Nuitka command that should work everywhere
        python -m nuitka main.py \
          --standalone \
          --enable-plugin=pyside6 \
          --include-data-dir=Themes=Themes \
          --include-data-file=Main.ui=. \
          --include-data-file=Find.ui=. \
          --include-data-file=FindNext.ui=. \
          --include-data-file=FindPrev.ui=. \
          --include-data-file=Replace.ui=. \
          --include-data-file=Themes.ui=. \
          --include-data-file=settings.json=. \
          --include-package-data=qt_themes \
          --include-qt-plugins=sensible \
          --output-dir=build \
          --jobs=1 \
          --lto=no \
          --assume-yes-for-downloads

    # Windows-specific: Rename and disable console
    - name: Post-process Windows Build
      if: runner.os == 'Windows'
      run: |
        cd build
        echo "=== Windows build contents ==="
        ls -la
        # Rename main.exe to Notepad.exe if it exists
        if [ -f "main.exe" ]; then
          mv main.exe Notepad.exe
          echo "Renamed main.exe to Notepad.exe"
        fi
        # If we have a dist folder, rename it
        if [ -d "main.dist" ]; then
          mv main.dist Notepad.dist
          echo "Renamed main.dist to Notepad.dist"
          # Also rename the executable inside
          if [ -f "Notepad.dist/main.exe" ]; then
            mv Notepad.dist/main.exe Notepad.dist/Notepad.exe
            echo "Renamed internal executable"
          fi
        fi

    # macOS-specific: Create app bundle
    - name: Post-process macOS Build
      if: runner.os == 'macOS'
      run: |
        cd build
        echo "=== macOS build contents ==="
        ls -la
        
        # Rename main to Notepad if it exists
        if [ -f "main" ]; then
          mv main Notepad
          chmod +x Notepad
          echo "Renamed main to Notepad"
        fi
        
        # Rename dist folder
        if [ -d "main.dist" ]; then
          mv main.dist Notepad.dist
          echo "Renamed main.dist to Notepad.dist"
          # Rename internal executable
          if [ -f "Notepad.dist/main" ]; then
            mv Notepad.dist/main Notepad.dist/Notepad
            chmod +x Notepad.dist/Notepad
            echo "Renamed internal executable"
          fi
        fi
        
        # Create app bundle
        if [ -d "Notepad.dist" ]; then
          echo "Creating macOS app bundle..."
          mkdir -p Notepad.app/Contents/MacOS
          mkdir -p Notepad.app/Contents/Resources
          cp -r Notepad.dist/* Notepad.app/Contents/MacOS/
          
          # Create Info.plist without heredoc
          cat > Notepad.app/Contents/Info.plist << "EOF"
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>Notepad</string>
    <key>CFBundleIdentifier</key>
    <string>com.notepad.app</string>
    <key>CFBundleName</key>
    <string>Notepad</string>
    <key>CFBundleVersion</key>
    <string>1.0</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0</string>
    <key>NSHighResolutionCapable</key>
    <true/>
</dict>
</plist>
EOF
          echo "Created macOS app bundle"
        fi

    # Linux-specific: Rename and make executable
    - name: Post-process Linux Build
      if: runner.os == 'Linux'
      run: |
        cd build
        echo "=== Linux build contents ==="
        ls -la
        
        # Rename main to Notepad if it exists
        if [ -f "main" ]; then
          mv main Notepad
          chmod +x Notepad
          echo "Renamed main to Notepad"
        fi
        
        # Rename dist folder
        if [ -d "main.dist" ]; then
          mv main.dist Notepad.dist
          echo "Renamed main.dist to Notepad.dist"
          # Rename internal executable
          if [ -f "Notepad.dist/main" ]; then
            mv Notepad.dist/main Notepad.dist/Notepad
            chmod +x Notepad.dist/Notepad
            echo "Renamed internal executable"
          fi
        fi

    # Final verification
    - name: Verify Final Outputs
      run: |
        echo "=== Final outputs for ${{ runner.os }} ==="
        cd build
        find . -type f -name "Notepad*" -o -name "*.exe" 2>/dev/null | head -20
        find . -type d -name "*.app" -o -name "*.dist" 2>/dev/null | head -10

    # Upload artifacts
    - name: Upload Windows Artifacts
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: Notepad-Windows
        path: |
          build/Notepad.exe
          build/Notepad.dist/
        if-no-files-found: warn

    - name: Upload macOS Artifacts
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: Notepad-macOS
        path: |
          build/Notepad
          build/Notepad.dist/
          build/Notepad.app/
        if-no-files-found: warn

    - name: Upload Linux Artifacts
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: Notepad-Linux
        path: |
          build/Notepad
          build/Notepad.dist/
        if-no-files-found: warn

    # Upload complete build directory as backup
    - name: Upload Complete Build
      uses: actions/upload-artifact@v4
      with:
        name: Complete-Build-${{ runner.os }}
        path: build/
        if-no-files-found: warn