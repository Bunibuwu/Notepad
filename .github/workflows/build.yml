name: CI - Build Notepad App (Nuitka)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with Nuitka
      run: |
        mkdir -p build
        
        # Platform-specific Nuitka commands
        if [ "$RUNNER_OS" = "Windows" ]; then
          python -m nuitka main.py `
            --standalone `
            --enable-plugin=pyside6 `
            --include-data-dir=Themes=Themes `
            --include-data-file=Main.ui=Main.ui `
            --include-data-file=Find.ui=Find.ui `
            --include-data-file=FindNext.ui=FindNext.ui `
            --include-data-file=FindPrev.ui=FindPrev.ui `
            --include-data-file=Replace.ui=Replace.ui `
            --include-data-file=Themes.ui=Themes.ui `
            --include-data-file=settings.json=settings.json `
            --include-package-data=qt_themes `
            --include-qt-plugins=sensible `
            --output-dir=build `
            --jobs=2 `
            --lto=no `  # Disable LTO to speed up compilation
            --windows-console-mode=disable `
            --output-filename=Notepad
        elif [ "$RUNNER_OS" = "macOS" ]; then
          python -m nuitka main.py \
            --standalone \
            --enable-plugin=pyside6 \
            --include-data-dir=Themes=Themes \
            --include-data-file=Main.ui=Main.ui \
            --include-data-file=Find.ui=Find.ui \
            --include-data-file=FindNext.ui=FindNext.ui \
            --include-data-file=FindPrev.ui=FindPrev.ui \
            --include-data-file=Replace.ui=Replace.ui \
            --include-data-file=Themes.ui=Themes.ui \
            --include-data-file=settings.json=settings.json \
            --include-package-data=qt_themes \
            --include-qt-plugins=sensible \
            --output-dir=build \
            --jobs=2 \
            --lto=no \
            --macos-create-app-bundle \
            --output-filename=Notepad
        else
          # Linux
          python -m nuitka main.py \
            --standalone \
            --enable-plugin=pyside6 \
            --include-data-dir=Themes=Themes \
            --include-data-file=Main.ui=Main.ui \
            --include-data-file=Find.ui=Find.ui \
            --include-data-file=FindNext.ui=FindNext.ui \
            --include-data-file=FindPrev.ui=FindPrev.ui \
            --include-data-file=Replace.ui=Replace.ui \
            --include-data-file=Themes.ui=Themes.ui \
            --include-data-file=settings.json=settings.json \
            --include-package-data=qt_themes \
            --include-qt-plugins=sensible \
            --output-dir=build \
            --jobs=2 \
            --lto=no \
            --output-filename=Notepad
        fi

    - name: Fix macOS app bundle structure
      if: runner.os == 'macOS'
      run: |
        cd build
        if [ -d "Notepad.app" ]; then
          # Ensure the app bundle has proper structure
          if [ ! -f "Notepad.app/Contents/MacOS/Notepad" ]; then
            # If the main executable is in a .dist folder, move it
            if [ -f "Notepad.dist/Notepad" ]; then
              mkdir -p "Notepad.app/Contents/MacOS"
              cp "Notepad.dist/Notepad" "Notepad.app/Contents/MacOS/Notepad"
              chmod +x "Notepad.app/Contents/MacOS/Notepad"
            fi
          fi
        fi

    - name: Make executable (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        cd build
        # For regular executables
        if [ -f "Notepad" ]; then
          chmod +x Notepad
        fi
        # For .dist folders
        if [ -d "Notepad.dist" ] && [ -f "Notepad.dist/Notepad" ]; then
          chmod +x Notepad.dist/Notepad
        fi
        # For app bundles on macOS
        if [ -d "Notepad.app" ] && [ -f "Notepad.app/Contents/MacOS/Notepad" ]; then
          chmod +x Notepad.app/Contents/MacOS/Notepad
        fi

    - name: List build contents for debugging
      run: |
        echo "=== Build directory structure ==="
        find build/ -type f -name "Notepad*" -o -name "*.exe" -o -name "*.app" | head -20
        if [ -d "build/Notepad.dist" ]; then
          echo "=== Notepad.dist contents ==="
          ls -la build/Notepad.dist/ | head -10
        fi
        if [ -d "build/Notepad.app" ]; then
          echo "=== Notepad.app contents ==="
          find build/Notepad.app -type f | head -10
        fi

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Notepad-${{ runner.os }}
        path: |
          build/Notepad.exe
          build/Notepad
          build/Notepad.dist/
          build/Notepad.app/
        if-no-files-found: warn